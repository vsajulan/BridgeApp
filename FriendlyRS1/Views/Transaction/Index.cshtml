@model IEnumerable<FriendlyRS1.ViewModels.AppointmentTransactionVM>
@using FriendlyRS1.ViewModels

@{
    Layout = "~/Views/Shared/_Layout1.cshtml";
    ViewData["Title"] = "Appointment Transactions";
    var pager = ViewBag.Pager as Pager;
    string currentSearch = ViewBag.Search as string ?? "";
}

<style>
    .container {
        margin: 0 auto;
        height: calc(100vh - 100px);
        overflow-x: hidden;
    }

    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }

</style>

<div class="container py-2">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary mb-0">
            <i class="fas fa-exchange-alt me-2"></i> Appointment Transactions
        </h3>
    </div>
    <!-- 🔍 Search Form -->
    <form method="get" class="row g-2 mb-4" id="searchForm">
        <div class="col-md-4">
            <input type="text"
                   name="search"
                   value="@currentSearch"
                   class="form-control"
                   placeholder="Search by Appointer or Appointee..." />
        </div>
        <div class="col-md-3">
            <input type="date" name="startDate" value="@ViewBag.StartDate" class="form-control" placeholder="From Date" />
        </div>
        <div class="col-md-3">
            <input type="date" name="endDate" value="@ViewBag.EndDate" class="form-control" placeholder="To Date" />
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-filter me-1"></i> Filter
            </button>
        </div>
    </form>

    <div class="table-responsive shadow-sm rounded">
        <table id="transactionTable" class="table table-striped table-hover align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th>Transaction ID</th>
                    <th>Appointer</th>
                    <th>Appointee</th>
                    <th>Appointment Status</th>
                    <th>Payment Method</th>
                    <th>Payment Status</th>
                    <th>Created Date</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No transactions found.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model)
                    {
                        <tr class="transaction-row" data-id="@item.Id">
                            <td>@(item.TransanctionId ?? "-")</td>
                            <td>@item.AuthorName</td>
                            <td>@item.ReceiverName</td>
                            <td>
                                <span class="badge
                                    @(item.AppointmentStatus == AppointmentStatus.Pending ? "bg-warning text-dark" :
                                      item.AppointmentStatus == AppointmentStatus.Accepted ? "bg-success" :
                                      item.AppointmentStatus == AppointmentStatus.Cancelled ? "bg-danger" :
                                      item.AppointmentStatus == AppointmentStatus.Completed ? "bg-primary" :
                                      item.AppointmentStatus == AppointmentStatus.Rejected ? "bg-secondary" : "bg-dark")">
                                    @item.AppointmentStatusString
                                </span>
                            </td>
                            <td>@item.PaymentMethod</td>
                            <td>
                                <span class="badge bg-@(item.PaymentStatus == PaymentStatus.Paid ? "success"
                                    : item.PaymentStatus == PaymentStatus.Pending ? "warning text-dark"
                                    : item.PaymentStatus == PaymentStatus.Failed ? "danger"
                                    : "secondary")">
                                    @item.PaymentStatusString
                                </span>
                            </td>
                            <td>@item.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @* Pager links *@
    @if (pager != null)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                @if (pager.CurrentPage > 1)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new {
                            page = pager.CurrentPage - 1,
                            pageSize = pager.PageSize,
                            search = currentSearch,
                            startDate = ViewBag.StartDate,
                            endDate = ViewBag.EndDate
                        })">Previous</a>
                    </li>
                }

                @for (int i = 1; i <= pager.TotalPages; i++)
                {
                    <li class="page-item @(i == pager.CurrentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new {
                            page = i,
                            pageSize =
                            pager.PageSize,
                            search = currentSearch,
                            startDate = ViewBag.StartDate,
                            endDate = ViewBag.EndDate
                        })">@i</a>
                    </li>
                }

                @if (pager.CurrentPage < pager.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" href="@Url.Action("Index", new {
                        page = pager.CurrentPage + 1,
                        pageSize = pager.PageSize,
                        search = currentSearch,
                        startDate = ViewBag.StartDate,
                        endDate = ViewBag.EndDate
                    })">Next</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<div id="appointmentDetailsModalContainer"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {

        // Use delegated event for dynamic content (optional if table reloads)
        $('#transactionTable').on('click', '.transaction-row', function () {
            var appointmentId = $(this).data('id');

            $.get('/Transaction/AppointmentDetailsPartial', { appointmentId: appointmentId }, function (html) {
                $('#appointmentDetailsModalContainer').html(html);

                const modalEl = document.getElementById('appointmentDetailsModal');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } else {
                    console.error("❌ appointmentDetailsModal element not found");
                }
            });
        });
    });
</script>
