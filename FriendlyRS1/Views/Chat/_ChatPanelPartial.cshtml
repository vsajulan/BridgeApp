@model List<FriendlyRS1.ViewModels.ChatVM>
@using System.Security.Claims
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var chatMateName = ViewData["ChatMateName"] as string;
    var chatMateImage = ViewData["ChatMateProfileImage"] as byte[];
    var loggedImage = ViewData["LoggedProfileImage"] as byte[];
    var chatMateId = ViewData["ChatMateId"];
    var currentUserId = HttpContextAccessor.HttpContext.User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<div class="chat-panel border rounded bg-white d-flex flex-column" style="height:100%;">
    <!-- Header -->
    <div class="chat-header d-flex align-items-center border-bottom p-3 bg-light">
        @if (chatMateImage != null)
        {
            <img src="data:image/*;base64,@(Convert.ToBase64String(chatMateImage))"
                 alt="User" class="rounded-circle"
                 width="45" height="45">
        }
        else
        {
            <img src="/avatar.png" alt="User" class="rounded-circle me-2"
                 width="45" height="45">
        }

        <div>
            <div class="fw-bold">@chatMateName</div>
            <div class="text-muted small">Active now</div>
        </div>
    </div>

    <!-- Body -->
    <div id="chatBody" class="chat-body flex-grow-1 p-3 overflow-auto" style="background-color:#f9f9f9;">
        @foreach (var msg in Model)
        {
            <div class="d-flex mb-3 @(msg.IsMe ? "justify-content-end" : "justify-content-start") align-items-center">
                @if (!msg.IsMe)
                {
                    <img src="@(msg.SenderProfileImage != null
                ? $"data:image/*;base64,{Convert.ToBase64String(msg.SenderProfileImage)}"
                : "/avatar.png")"
                         class="rounded-circle me-3" width="45" height="45" />
                }

                <div class="p-2 rounded-3" style="max-width:70%;">
                    <div>@msg.MessageText</div>
                    <div class="text-end mt-1">
                        <small class="text-muted" style="font-size:0.75rem;">@msg.SentTimeFormatted</small>
                    </div>
                </div>

                @if (msg.IsMe)
                {
                    <img src="@(msg.SenderProfileImage != null
                ? $"data:image/*;base64,{Convert.ToBase64String(msg.SenderProfileImage)}"
                : "/avatar.png")"
                         class="rounded-circle ms-3" width="45" height="45" />
                }
            </div>
        }
    </div>

    <!-- Input -->
    <div class="chat-input border-top p-3 bg-light d-flex align-items-center">
        <input type="text" class="form-control me-2" id="newMessage" placeholder="Type a message..." />
        <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
    </div>
</div>

<script>
    // 🟢 Global chat connection (prevent multiple instances)
    window.chatConnection = window.chatConnection || null;

    $(document).ready(function () {
        const receiverId = '@chatMateId';
        const currentUserId = '@currentUserId';
        const $chatBody = $('#chatBody');

        // 🟢 Scroll to bottom by default
        $chatBody.scrollTop($chatBody[0].scrollHeight);

        // 🟢 Initialize SignalR only once
        if (!window.chatConnection) {
            window.chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .build();

            window.chatConnection
                .start()
                .then(() => {
                    console.log("✅ Connected to ChatHub");
                    const currentUserId = '@currentUserId';
                    window.chatConnection.invoke("JoinUserGroup", currentUserId);
                })
                .catch(err => console.error("SignalR connection error:", err));

            // 🧹 Cleanup old listeners
            window.chatConnection.off("ReceiveMessage");


            const loggedProfileImage = '@(loggedImage != null ? Convert.ToBase64String(loggedImage) : "")';
            const chatMateProfileImage = '@(chatMateImage != null ? Convert.ToBase64String(chatMateImage) : "")';

            // ♻️ Real-time message handler
            window.chatConnection.on("ReceiveMessage", (data) => {
                const { senderId, receiverId: recId, messageText, sentDate } = data;
                const receiverId = '@chatMateId';
                const currentUserId = '@currentUserId';
                const $chatBody = $('#chatBody');

                // Only show if this conversation involves me
                if (recId == receiverId || senderId == receiverId) {
                    const isMe = senderId == currentUserId;

                    const avatarSrc = isMe
                        ? (loggedProfileImage ? `data:image/*;base64,${loggedProfileImage}` : '/avatar.png')
                        : (chatMateProfileImage ? `data:image/*;base64,${chatMateProfileImage}` : '/avatar.png');
                    const msgDiv = `
                        <div class="d-flex mb-3 ${isMe ? 'justify-content-end' : 'justify-content-start'} align-items-center">
                                            ${!isMe ? ` <img src="${avatarSrc}" class="rounded-circle me-2" width="45" height="45">` : ''}
                            <div class="p-2 rounded-3" style="max-width:70%;">
                                <div>${messageText}</div>
                                <div class="text-end mt-1">
                                    <small class="text-muted" style="font-size:0.75rem;">${sentDate}</small>
                                </div>
                            </div>
                                            ${isMe ? ` <img src="${avatarSrc}" class="rounded-circle ms-2" width="45" height="45">` : ''}
                        </div>`;
                    $chatBody.append(msgDiv);
                    $chatBody.scrollTop($chatBody[0].scrollHeight);
                }
            });

            // 🟢 When someone sends or receives a new message, update the sidebar
            window.chatConnection.on("UpdateChatList", function () {
                $('.chat-list').fadeTo(200, 0.5);
                $.get('/Chat/GetChatListPartial', function (html) {
                    $('.chat-list').html(html).fadeTo(200, 1);
                });
            });
        }
    });

    $('#newMessage').on('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { // Enter without Shift
            e.preventDefault(); // prevent new line
            sendChatMessage();
        }
    });

    // ✅ Send message (relies on SignalR broadcast)
    function sendChatMessage() {
        const input = $('#newMessage');
        const text = input.val().trim();
        if (!text) return alert("Please enter a message.");

        const receiverId = '@chatMateId';

        $.post(`/Chat/SendMessage`, { ReceiverId: receiverId, MessageText: text })
            .done(res => {
                if (res.success) {
                    input.val("");
                } else {
                    alert("Failed to send message.");
                }
            })
            .fail(() => alert("❌ Failed to send message."));
    }
</script>
