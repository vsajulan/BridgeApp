    @model List<ShowPostVM>
@{
    ViewData["Title"] = "LoadPosts";
    Layout = null;
}
<style>
    .three-dots {
        cursor: pointer;
    }
</style>

@foreach (var item in Model)
{
    <div class="tab-content p-0" id="@($"post{item.Id}")">
        <div class="tab-pane fade active show" id="profile-post">
            <ul class="timeline">
                <li>
                    <div class="timeline-time">
                        <span class="time">@item.DateCreated.ToString("HH:mm")</span>
                        <time class="timeago date" datetime="@item.DateCreated">
                        </time>
                        @*<span class="date">today</span>*@
                    </div>
                    <div class="timeline-icon">
                        <a href="javascript:;">&nbsp;</a>
                    </div>
                    <div class="timeline-body">
                        <div>
                            <div class="d-flex flex-column shadow rounded bg-white p-3 mb-3">
                                <div class=" d-flex justify-content-between mb-2">
                                    <div class="d-flex">
                                        @if (item.ProfileImage != null)
                                        {
                                            <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">
                                                <img src="data:image/*;base64,@(Convert.ToBase64String(item.ProfileImage))" class="rounded-circle border-dark slika" style="height: 60px; width: 60px; background-size: cover; background-position: center;">
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">
                                                <img src="/avatar.png" class="rounded-circle border-dark slika" style="height: 60px; width: 60px; background-size: cover; background-position: center;">
                                            </a>
                                        }
                                        <div class="pl-2">
                                            <div class="font-weight-bold "><a class="text-primary" asp-controller="UserProfile" asp-action="Index" asp-route-id="@item.AuthorId">@item.AuthorName</a></div>
                                            <div class="text-secondary" style="font-size:.85em">
                                                @item.Date
                                            </div>
                                        </div>
                                    </div>

                                    <div style="position: relative">
                                        @if (item.IsMe)
                                        {
                                            @*<a onclick="EditPost(@item.Id)" ><i class="fas fa-ellipsis-h fa-lg text-secondary three-dots" data-toggle="modal" data-target="#exampleModal" ></i></a>*@
                                            <i class="fas fa-ellipsis-h fa-lg text-secondary three-dots" onclick="TogglePostMenu(@item.Id)"></i>
                                            <div class="post-menu shadow rounded bg-light" id="@($"postMenu{item.Id}")">
                                                <div class="text-secondary">Options</div>
                                                <hr style="width:100%; margin: .6em 0px" />
                                                <div class="mb-1">
                                                    <button data-toggle="modal" data-target="#exampleModal" class="btn btn-warning w-100" onclick="EditPost(@item.Id)">Edit Post</button>
                                                </div>
                                                <div>
                                                    <button class="btn btn-danger w-100" onclick="DeletePost(@item.Id)">Delete Post</button>
                                                </div>
                                            </div>

                                        }
                                    </div>
                                </div>

                                <div class="post-hobby">
                                    <p class="text-secondary">@item.Hobby</p>
                                </div>

                                <div class="post-text">
                                    <p>
                                        @item.Text
                                    </p>
                                </div>

                                <div class="d-flex justify-content-between text-secondary">
                                    <a>0 interests</a>
                                    <a>@item.Comments.Count() comments</a>
                                </div>
                                <hr style="width: 100%" />
                                <div class="d-flex">
                                    <button class="flex-grow-1 btn btn-light mr-2">
                                        <i class="far fa-handshake text-secondary fa-lg"></i>
                                        <span class="text-secondary">Interested</span>
                                    </button>

                                    <button class="flex-grow-1 btn btn-light" onclick="toggleCommentBox(@item.Id)">
                                        <i class="far fa-comment-alt text-secondary fa-lg"></i>
                                        <span>Comment</span>
                                    </button>
                                </div>

                                <!-- Comment Section -->
                                <div id="@($"commentSection{item.Id}")" class="mt-3 d-none">
                                    <div id="@($"commentsList{item.Id}")">
                                        @foreach (var c in item.Comments)
                                        {
                                            <div id="comment-@c.Id" class="border rounded p-2 mb-2 bg-light d-flex justify-content-between align-items-start">
                                                <div>
                                                    <div>sdads</div>
                                                    <strong>@c.AuthorName:</strong>
                                                    <p class="mb-0">@c.Text</p>
                                                    <small class="text-muted">@c.DateCreated</small>
                                                </div>
                                                @if (item.AuthorId == c.AuthorId)
                                                {
                                                    <div class="ml-2">
                                                        <i class="fas fa-edit text-secondary mr-2" style="cursor:pointer;" title="Edit" onclick="editComment(@item.Id, @c.Id)"></i>
                                                        <i class="fas fa-trash text-secondary" style="cursor:pointer;" title="Delete" onclick="deleteComment(@item.Id, @c.Id)"></i>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <!-- Add New Comment -->
                                    <div class="d-flex mt-2">
                                        <input type="text" class="form-control mr-2" id="@($"newComment{item.Id}")" placeholder="Write a comment..." />
                                        <button class="btn btn-primary" onclick="addComment(@item.Id)">Post</button>
                                    </div>
                                </div>



                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

}
<script>
    // 🟢 Global connection (prevent reinit)
    window.commentConnection = window.commentConnection || null;

    $(document).ready(function () {
        $("time.timeago").timeago();

        // 🟢 Initialize SignalR only once
        if (!window.commentConnection) {
            window.commentConnection = new signalR.HubConnectionBuilder()
                .withUrl("/commentHub")
                .build();

            window.commentConnection
                .start()
                .then(() => {
                    console.log("✅ Connected to SignalR");

                    // Join groups for all posts
                    $(".tab-content").each(function () {
                        const postId = $(this).attr("id").replace("post", "");
                        window.commentConnection.invoke("JoinPostGroup", parseInt(postId));
                        console.log("Joined post group:", postId);
                    });
                })
                .catch(err => console.error("SignalR connection error:", err));

            // 🧹 Cleanup old listeners
            window.commentConnection.off("ReloadComments");

            // ♻️ SignalR reload trigger
            window.commentConnection.on("ReloadComments", (postId) => {
                console.log("♻️ Reloading comments for post:", postId);
                loadComments(postId);
            });
        }
    });

    // ✅ Toggle comment section
    function toggleCommentBox(postId) {
        const section = $(`#commentSection${postId}`);
        section.toggleClass("d-none");
        if (!section.hasClass("d-none")) loadComments(postId);
    }

    // ✅ Load comments from server (used by SignalR reload)
    function loadComments(postId) {
        $.get(`/Comment/GetComments?postId=${postId}`)
            .done(res => {
                if (res.success && res.comments) {
                    const list = $(`#commentsList${postId}`);
                    list.empty();
                    res.comments.forEach(c => {
                        list.append(`
                                            <div id="comment-${c.id}" class="border rounded p-2 mb-2 bg-light d-flex justify-content-between align-items-start">
                                            <div>
                                                        <strong>${c.authorName || "Anonymous"}:</strong>
                                                        <p class="mb-0">${c.text}</p>
                                                        <small class="text-muted">${c.dateCreated}</small>
                                            </div>
                                                ${c.isMe ? `
                                            <div class="ml-2">
                                                    <i class="fas fa-edit text-secondary mr-2" style="cursor:pointer;" title="Edit" onclick="editComment(${postId}, ${c.id})"></i>
                                                    <i class="fas fa-trash text-secondary" style="cursor:pointer;" title="Delete" onclick="deleteComment(${postId}, ${c.id})"></i>
                                            </div>
                                            ` : ""}
                                        </div>
                                    `);
                    });
                }
            })
            .fail(() => console.error("❌ Failed to load comments."));
    }

    // ✅ Add comment (broadcast triggers SignalR reload)
    function addComment(postId) {
        const input = $(`#newComment${postId}`);
        const text = input.val().trim();
        if (!text) return alert("Please enter a comment.");

        $.post(`/Comment/AddComment`, { postId, text })
            .done(res => {
                if (res.success) {
                    input.val(""); // clear
                    // 🚫 Do NOT reload manually — SignalR will broadcast reload
                } else {
                    alert("Failed to add comment.");
                }
            })
            .fail(() => alert("❌ Failed to post comment."));
    }

    // ✏️ Edit comment
    function editComment(postId, commentId) {
        const commentEl = $(`#comment-${commentId}`);
        const currentText = commentEl.find("p").text();
        const newText = prompt("Edit your comment:", currentText);
        if (newText === null || newText.trim() === "") return;

        $.post(`/Comment/UpdateComment`, { id: commentId, text: newText.trim() })
            .done(res => {
                if (res.success) {
                    // 🚫 No manual reload — SignalR will trigger ReloadComments
                } else {
                    alert("Failed to update comment.");
                }
            })
            .fail(() => alert("❌ Failed to update comment."));
    }

    // 🗑 Delete comment
    function deleteComment(postId, commentId) {
        if (!confirm("Are you sure you want to delete this comment?")) return;

        $.post(`/Comment/DeleteComment`, { id: commentId })
            .done(res => {
                if (res.success) {
                    // 🚫 No manual reload — SignalR will trigger ReloadComments
                } else {
                    alert("Failed to delete comment.");
                }
            })
            .fail(() => alert("❌ Failed to delete comment."));
    }
</script>




